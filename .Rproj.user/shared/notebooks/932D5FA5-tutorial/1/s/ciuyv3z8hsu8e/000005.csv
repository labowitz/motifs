"0","## Plot the most diverse profiles, aka the motifs"
"0","# 1. Select all profiles "
"0","diverse_df <- control_res$profiles"
"0","# 2. tidy data.frame to average gene expression within a pathway profile "
"0","diverse_df %>% pivot_longer(cols = genesPathway(pathway_name), "
"0","                            names_to = 'gene', "
"0","                            values_to = 'expression') %>% "
"0","           select(cell_id, cell_ontology_class, Tissue, Cell_class, gene, expression, class_label, rank, diversity, n) -> diverse_tidy "
"0",""
"0","diverse_tidy %>% group_by(class_label,gene) %>% summarise(mean_expr = mean(expression), "
"0","            rank = mean(rank),diversity = mean(diversity), "
"0","            cell_types = mean(n)) -> diverse_tidy"
"1","`summarise()` has grouped output by 'class_label'. You can override using the `.groups` argument.
"
"0","# 3. wide format "
"0","diverse_tidy %>% pivot_wider(id_cols = c(class_label,rank, diversity, cell_types), names_from=gene,values_from=mean_expr) %>% tibble::column_to_rownames('class_label')-> diverse_mat"
"0",""
"0","# 4. We do the filtering here either for motifs or for non-diverse profiles "
"0","control_res$diversity %>% "
"0","  dplyr::filter(type=='transcriptome') %>% # choose the null model "
"0","  pull(d) %>% quantile(0.90) -> divers_quantile"
"0",""
"0","diverse_mat %>% dplyr::filter(diversity>divers_quantile) -> diverse_mat"
"0",""
"0","motif_heatmap <- superheat(diverse_mat[,genesPathway(pathway_name)],"
"0","                           pretty.order.rows = T,"
"0","                           heat.pal = black_pal(10),"
"0","                           bottom.label.text.angle = 90, "
"0","                           yr = sqrt(diverse_mat$cell_types),"
"0","                           yr.plot.type='bar',"
"0","                           yr.axis.name = ""N cell types"","
"0","                           row.title = ""Pathway motifs"","
"0","                           column.title = ""Pathway genes"","
"0","                           bottom.label.size = 0.3,"
"0","                           grid.hline.col = ""white"","
"0","                           grid.hline.size = 2, "
"0","                           "
"0",")"
